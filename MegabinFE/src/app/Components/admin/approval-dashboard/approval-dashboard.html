<div class="space-y-4">
  <!-- Header -->
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold m-0 text-surface-900">Pending Approvals</h1>
    @if (totalPendingCount() > 0) {
      <p-badge [value]="totalPendingCount().toString()" severity="warn" />
    }
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="flex justify-center items-center py-12">
      <p-progressSpinner strokeWidth="4" />
    </div>
  } @else {
    <!-- Tabs -->
    <p-tabs value="0">
      <p-tablist>
        <p-tab value="0">
          <div class="flex items-center gap-2">
            <i class="pi pi-map-marker" aria-hidden="true"></i>
            <span>Addresses</span>
            @if (addressCount() > 0) {
              <p-badge [value]="addressCount().toString()" severity="info" />
            }
          </div>
        </p-tab>
        <p-tab value="1">
          <div class="flex items-center gap-2">
            <i class="pi pi-calendar" aria-hidden="true"></i>
            <span>Schedule Contracts</span>
            @if (contractCount() > 0) {
              <p-badge [value]="contractCount().toString()" severity="info" />
            }
          </div>
        </p-tab>
        <p-tab value="2">
          <div class="flex items-center gap-2">
            <i class="pi pi-truck" aria-hidden="true"></i>
            <span>Route Generation</span>
          </div>
        </p-tab>
      </p-tablist>

      <p-tabpanels>
        <!-- Addresses Tab -->
        <p-tabpanel value="0">
          @if (pendingAddresses().length === 0) {
            <div class="text-center py-12">
              <i class="pi pi-check-circle text-5xl text-surface-300 mb-4"></i>
              <p class="text-surface-500 m-0">No pending addresses</p>
              <p class="text-surface-400 text-sm m-0 mt-2">
                Addresses in final status can be managed from the Addresses section
              </p>
            </div>
          } @else if (isMobile()) {
            <!-- Mobile Card View -->
            <div class="flex flex-col gap-3">
              @for (item of pendingAddresses(); track item.addressId) {
                <p-card>
                  <div class="flex flex-col gap-3">
                    <div class="flex items-start justify-between">
                      <div class="flex-1 min-w-0">
                        <p class="font-medium m-0 truncate text-surface-900">
                          {{ item.userName }}
                        </p>
                        <p class="text-sm m-0 truncate text-surface-500">{{ item.address }}</p>
                        <div class="flex items-center gap-2 mt-2">
                          <p-tag severity="info" [value]="item.totalBins + ' bins'" />
                        </div>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <label
                        class="text-sm text-surface-600"
                        [attr.for]="'status-' + item.addressId"
                        >Status:</label
                      >
                      <p-select
                        [id]="'status-' + item.addressId"
                        [options]="addressStatusOptions"
                        [ngModel]="item.currentStatus"
                        (ngModelChange)="onAddressStatusChange(item, $event)"
                        optionLabel="label"
                        optionValue="value"
                        [disabled]="isProcessing(item.addressId)"
                        [loading]="isProcessing(item.addressId)"
                        class="flex-1"
                        appendTo="body"
                      />
                    </div>
                  </div>
                </p-card>
              }
            </div>
          } @else {
            <!-- Desktop Table View -->
            <p-table
              [value]="pendingAddresses()"
              [scrollable]="true"
              scrollHeight="400px"
              [tableStyle]="{ width: '100%' }"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th pSortableColumn="userName">Customer <p-sortIcon field="userName" /></th>
                  <th pSortableColumn="address">Address <p-sortIcon field="address" /></th>
                  <th>Bins</th>
                  <th>Current Status</th>
                  <th style="width: 14rem">Change Status</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-item>
                <tr>
                  <td>
                    <div>
                      <p class="font-medium m-0">{{ item.userName }}</p>
                      <p class="text-sm m-0 text-surface-500">{{ item.userEmail }}</p>
                    </div>
                  </td>
                  <td>{{ item.address }}</td>
                  <td>
                    <p-tag severity="info" [value]="item.totalBins + ' bins'" />
                  </td>
                  <td>
                    <p-tag
                      [severity]="getStatusSeverity(item.currentStatus)"
                      [value]="formatStatus(item.currentStatus)"
                    />
                  </td>
                  <td>
                    <p-select
                      [options]="addressStatusOptions"
                      [ngModel]="item.currentStatus"
                      (ngModelChange)="onAddressStatusChange(item, $event)"
                      optionLabel="label"
                      optionValue="value"
                      [disabled]="isProcessing(item.addressId)"
                      [loading]="isProcessing(item.addressId)"
                      [style]="{ width: '100%' }"
                      appendTo="body"
                      ariaLabel="Change address status"
                    />
                  </td>
                </tr>
              </ng-template>
            </p-table>
          }
        </p-tabpanel>

        <!-- Schedule Contracts Tab -->
        <p-tabpanel value="1">
          @if (pendingContracts().length === 0) {
            <div class="text-center py-12">
              <i class="pi pi-check-circle text-5xl text-surface-300 mb-4"></i>
              <p class="text-surface-500 m-0">No pending schedule contracts</p>
              <p class="text-surface-400 text-sm m-0 mt-2">
                Approved contracts can be managed from the Addresses section
              </p>
            </div>
          } @else if (isMobile()) {
            <!-- Mobile Card View -->
            <div class="flex flex-col gap-3">
              @for (contract of pendingContracts(); track contract.contractId) {
                <p-card>
                  <div class="flex flex-col gap-3">
                    <div class="flex items-start justify-between">
                      <div class="flex-1 min-w-0">
                        <p class="font-medium m-0 truncate text-surface-900">
                          {{ contract.userName }}
                        </p>
                        <p class="text-sm m-0 truncate text-surface-500">{{ contract.address }}</p>
                        <div class="flex items-center gap-2 mt-2 flex-wrap">
                          <p-tag
                            severity="secondary"
                            [value]="formatFrequency(contract.frequency)"
                          />
                          <p-tag
                            severity="contrast"
                            [value]="formatDayOfWeek(contract.dayOfWeek)"
                          />
                        </div>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <label
                        class="text-sm text-surface-600"
                        [attr.for]="'approval-' + contract.contractId"
                        >Status:</label
                      >
                      <p-select
                        [id]="'approval-' + contract.contractId"
                        [options]="approvalStatusOptions"
                        [ngModel]="contract.approvedExternally"
                        (ngModelChange)="onContractApprovalChange(contract, $event)"
                        optionLabel="label"
                        optionValue="value"
                        [disabled]="isProcessing(contract.contractId)"
                        [loading]="isProcessing(contract.contractId)"
                        class="flex-1"
                        appendTo="body"
                      />
                    </div>
                  </div>
                </p-card>
              }
            </div>
          } @else {
            <!-- Desktop Table View -->
            <p-table
              [value]="pendingContracts()"
              [scrollable]="true"
              scrollHeight="400px"
              [tableStyle]="{ width: '100%' }"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th pSortableColumn="userName">Customer <p-sortIcon field="userName" /></th>
                  <th pSortableColumn="address">Address <p-sortIcon field="address" /></th>
                  <th>Frequency</th>
                  <th>Day</th>
                  <th>Current Status</th>
                  <th style="width: 12rem">Change Status</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-contract>
                <tr>
                  <td>
                    <div>
                      <p class="font-medium m-0">{{ contract.userName }}</p>
                      <p class="text-sm m-0 text-surface-500">{{ contract.userEmail }}</p>
                    </div>
                  </td>
                  <td>{{ contract.address }}</td>
                  <td>
                    <p-tag severity="secondary" [value]="formatFrequency(contract.frequency)" />
                  </td>
                  <td>
                    <p-tag severity="contrast" [value]="formatDayOfWeek(contract.dayOfWeek)" />
                  </td>
                  <td>
                    <p-tag severity="warn" value="Pending Approval" />
                  </td>
                  <td>
                    <p-select
                      [options]="approvalStatusOptions"
                      [ngModel]="contract.approvedExternally"
                      (ngModelChange)="onContractApprovalChange(contract, $event)"
                      optionLabel="label"
                      optionValue="value"
                      [disabled]="isProcessing(contract.contractId)"
                      [loading]="isProcessing(contract.contractId)"
                      [style]="{ width: '100%' }"
                      appendTo="body"
                      ariaLabel="Change approval status"
                    />
                  </td>
                </tr>
              </ng-template>
            </p-table>
          }
        </p-tabpanel>

        <!-- Route Generation Tab -->
        <p-tabpanel value="2">
          <div class="flex flex-col gap-4">
            <!-- Date Selection and Actions -->
            <div class="flex flex-wrap items-center gap-4">
              <div class="flex items-center gap-2">
                <label for="route-date" class="text-sm font-medium text-surface-700"
                  >Select Date:</label
                >
                <p-datepicker
                  id="route-date"
                  [ngModel]="selectedDate()"
                  (ngModelChange)="onDateChange($event)"
                  dateFormat="yy-mm-dd"
                  [showIcon]="true"
                  appendTo="body"
                />
              </div>
              <p-button
                label="Load Preview"
                icon="pi pi-refresh"
                [loading]="routePreviewLoading()"
                (onClick)="loadRoutePreview()"
                severity="secondary"
              />
              <p-button
                label="Generate Routes"
                icon="pi pi-play"
                [loading]="routeGenerating()"
                [disabled]="routePreviewLoading() || routePreviewCount() === 0"
                (onClick)="triggerRouteGeneration()"
              />
            </div>

            <!-- Preview Stats -->
            @if (routePreviewLoading()) {
              <div class="flex justify-center items-center py-8">
                <p-progressSpinner strokeWidth="4" />
              </div>
            } @else if (routePreview()) {
              <div class="flex flex-wrap gap-4">
                <p-card styleClass="flex-1 min-w-[200px]">
                  <div class="flex items-center gap-3">
                    <div
                      class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-100"
                    >
                      <i class="pi pi-calendar text-xl text-blue-600" aria-hidden="true"></i>
                    </div>
                    <div>
                      <p class="text-sm text-surface-500 m-0">Day of Week</p>
                      <p class="text-xl font-semibold m-0">
                        {{ formatDayOfWeek(routePreview()!.dayOfWeek) }}
                      </p>
                    </div>
                  </div>
                </p-card>
                <p-card styleClass="flex-1 min-w-[200px]">
                  <div class="flex items-center gap-3">
                    <div
                      class="flex items-center justify-center w-12 h-12 rounded-full bg-green-100"
                    >
                      <i class="pi pi-users text-xl text-green-600" aria-hidden="true"></i>
                    </div>
                    <div>
                      <p class="text-sm text-surface-500 m-0">Active Drivers</p>
                      <p class="text-xl font-semibold m-0">
                        {{ routePreview()!.activeDriverCount }}
                      </p>
                    </div>
                  </div>
                </p-card>
                <p-card styleClass="flex-1 min-w-[200px]">
                  <div class="flex items-center gap-3">
                    <div
                      class="flex items-center justify-center w-12 h-12 rounded-full bg-purple-100"
                    >
                      <i class="pi pi-map-marker text-xl text-purple-600" aria-hidden="true"></i>
                    </div>
                    <div>
                      <p class="text-sm text-surface-500 m-0">Contracts to Process</p>
                      <p class="text-xl font-semibold m-0">
                        {{ routePreview()!.scheduleContracts?.length ?? 0 }}
                      </p>
                    </div>
                  </div>
                </p-card>
                <p-card styleClass="flex-1 min-w-[200px]">
                  <div class="flex items-center gap-3">
                    <div
                      class="flex items-center justify-center w-12 h-12 rounded-full"
                      [class]="
                        routePreview()!.existingCollectionsCount > 0
                          ? 'bg-orange-100'
                          : 'bg-gray-100'
                      "
                    >
                      <i
                        class="pi pi-check-circle text-xl"
                        [class]="
                          routePreview()!.existingCollectionsCount > 0
                            ? 'text-orange-600'
                            : 'text-gray-600'
                        "
                        aria-hidden="true"
                      ></i>
                    </div>
                    <div>
                      <p class="text-sm text-surface-500 m-0">Existing Collections</p>
                      <p class="text-xl font-semibold m-0">
                        {{ routePreview()!.existingCollectionsCount }}
                      </p>
                    </div>
                  </div>
                </p-card>
              </div>

              @if (routePreview()!.existingCollectionsCount > 0) {
                <div class="p-3 bg-orange-50 border border-orange-200 rounded-lg">
                  <div class="flex items-center gap-2 text-orange-700">
                    <i class="pi pi-exclamation-triangle" aria-hidden="true"></i>
                    <span class="font-medium"
                      >Warning: {{ routePreview()!.existingCollectionsCount }} existing collections
                      will be replaced if you regenerate routes.</span
                    >
                  </div>
                </div>
              }

              <!-- Schedule Contracts Table -->
              @if ((routePreview()!.scheduleContracts?.length ?? 0) === 0) {
                <div class="text-center py-12">
                  <i class="pi pi-inbox text-5xl text-surface-300 mb-4"></i>
                  <p class="text-surface-500 m-0">No schedule contracts for this day</p>
                  <p class="text-surface-400 text-sm m-0 mt-2">
                    No active, approved contracts are scheduled for
                    {{ formatDayOfWeek(routePreview()!.dayOfWeek) }}
                  </p>
                </div>
              } @else if (isMobile()) {
                <!-- Mobile Card View -->
                <div class="flex flex-col gap-3">
                  @for (
                    contract of routePreview()!.scheduleContracts ?? [];
                    track contract.contractId
                  ) {
                    <p-card>
                      <div class="flex flex-col gap-2">
                        <div>
                          <p class="font-medium m-0 text-surface-900">
                            {{ contract.customerName }}
                          </p>
                          <p class="text-sm m-0 text-surface-500">{{ contract.address }}</p>
                        </div>
                        <div class="flex items-center gap-2 flex-wrap">
                          <p-tag
                            severity="secondary"
                            [value]="formatFrequency(contract.frequency)"
                          />
                          <p-tag severity="info" [value]="contract.totalBins + ' bins'" />
                        </div>
                      </div>
                    </p-card>
                  }
                </div>
              } @else {
                <!-- Desktop Table View -->
                <p-table
                  [value]="routePreview()!.scheduleContracts ?? []"
                  [scrollable]="true"
                  scrollHeight="400px"
                  [tableStyle]="{ width: '100%' }"
                >
                  <ng-template pTemplate="header">
                    <tr>
                      <th pSortableColumn="customerName">
                        Customer <p-sortIcon field="customerName" />
                      </th>
                      <th pSortableColumn="address">Address <p-sortIcon field="address" /></th>
                      <th>Frequency</th>
                      <th>Bins</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-contract>
                    <tr>
                      <td>
                        <div>
                          <p class="font-medium m-0">{{ contract.customerName }}</p>
                          <p class="text-sm m-0 text-surface-500">{{ contract.customerEmail }}</p>
                        </div>
                      </td>
                      <td>{{ contract.address }}</td>
                      <td>
                        <p-tag severity="secondary" [value]="formatFrequency(contract.frequency)" />
                      </td>
                      <td>
                        <p-tag severity="info" [value]="contract.totalBins + ' bins'" />
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              }
            } @else {
              <div class="text-center py-12">
                <i class="pi pi-calendar-plus text-5xl text-surface-300 mb-4"></i>
                <p class="text-surface-500 m-0">Select a date and click "Load Preview"</p>
                <p class="text-surface-400 text-sm m-0 mt-2">
                  View which schedule contracts will be included in route generation
                </p>
              </div>
            }
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  }
</div>
