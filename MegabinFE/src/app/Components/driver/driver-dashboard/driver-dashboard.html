<p-toast></p-toast>

<div class="p-4">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">Today's Route</h1>
    <div class="flex gap-2 items-center">
      <p-tag [value]="completedCount() + '/' + totalCount() + ' Completed'" severity="info"></p-tag>
      <p-button
        icon="pi pi-refresh"
        severity="secondary"
        [text]="true"
        (onClick)="loadTodaysRoute()"
        pTooltip="Refresh"
      />
    </div>
  </div>

  @if (nextStop()) {
    <p-card header="Next Stop" class="mb-4">
      <div class="flex justify-between items-start gap-4">
        <div class="flex-1">
          <p class="text-lg font-semibold">{{ nextStop()?.address }}</p>
          @if (nextStop()?.addressNotes) {
            <p class="text-sm text-gray-600 mt-1">{{ nextStop()?.addressNotes }}</p>
          }
          <p class="text-sm text-gray-500 mt-2">
            Stop #{{ nextStop()?.routeSequence }} of {{ totalCount() }}
          </p>
        </div>
        <p-button label="Drive" icon="pi pi-map-marker" (onClick)="openGoogleMaps(nextStop()!)" />
      </div>
    </p-card>
  }

  <p-table
    [value]="collections()"
    [tableStyle]="{ 'min-width': '50rem' }"
    [scrollable]="true"
    scrollHeight="60vh"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 60px">#</th>
        <th>Address</th>
        <th>Notes</th>
        <th style="width: 120px">Status</th>
        <th style="width: 150px">Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-collection>
      <tr [class.bg-green-50]="collection.collected">
        <td class="font-medium">{{ collection.routeSequence }}</td>
        <td>
          <div>
            <span class="font-medium">{{ collection.address }}</span>
            @if (collection.addressNotes) {
              <p class="text-sm text-gray-500 mt-1">{{ collection.addressNotes }}</p>
            }
          </div>
        </td>
        <td>
          <span class="text-sm">{{ collection.notes || '-' }}</span>
        </td>
        <td>
          @if (collection.collected) {
            <p-tag severity="success" value="Complete"></p-tag>
          } @else {
            <p-tag severity="warn" value="Pending"></p-tag>
          }
        </td>
        <td>
          <div class="flex gap-1">
            <p-button
              icon="pi pi-map-marker"
              severity="info"
              [text]="true"
              (onClick)="openGoogleMaps(collection)"
              pTooltip="Open in Maps"
            />
            <p-button
              icon="pi pi-pencil"
              severity="secondary"
              [text]="true"
              (onClick)="openNotesDialog(collection)"
              pTooltip="Add Notes"
            />
            @if (!collection.collected) {
              <p-button
                icon="pi pi-check"
                severity="success"
                [text]="true"
                (onClick)="markComplete(collection)"
                pTooltip="Mark Complete"
              />
            }
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5" class="text-center p-4">
          <div class="flex flex-col items-center gap-2">
            <i class="pi pi-inbox text-4xl text-gray-400"></i>
            <p class="text-gray-500">No collections scheduled for today</p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<p-dialog
  header="Collection Notes"
  [(visible)]="showNotesDialog"
  [modal]="true"
  [style]="{ width: '400px' }"
>
  <div class="flex flex-col gap-4">
    <label for="notes" class="font-medium">Notes</label>
    <textarea
      pTextarea
      id="notes"
      rows="4"
      [ngModel]="collectionNotes()"
      (ngModelChange)="collectionNotes.set($event)"
      placeholder="Enter notes about this collection..."
      class="w-full"
    ></textarea>
    <div class="flex justify-end gap-2">
      <p-button label="Cancel" severity="secondary" (onClick)="closeNotesDialog()" />
      <p-button label="Save" (onClick)="saveNotes()" />
    </div>
  </div>
</p-dialog>
