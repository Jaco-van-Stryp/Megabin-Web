<div class="space-y-4">
  <!-- Header -->
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold m-0 text-surface-900">Today's Route</h1>
    <div class="flex gap-2 items-center">
      <p-tag [value]="completedCount() + '/' + totalCount()" severity="info" />
      <p-button
        icon="pi pi-refresh"
        severity="secondary"
        [text]="true"
        [rounded]="true"
        (onClick)="loadTodaysRoute()"
        pTooltip="Refresh"
        ariaLabel="Refresh route"
      />
    </div>
  </div>

  @if (isLoading()) {
    <div class="flex justify-center items-center py-12">
      <p-progressSpinner strokeWidth="4" />
    </div>
  } @else {
    <!-- Next Stop Highlight Card -->
    @if (nextStop()) {
      <p-card styleClass="border-l-4 border-primary">
        <ng-template pTemplate="header">
          <div class="px-4 pt-4 pb-0">
            <span class="text-sm font-medium text-surface-500">NEXT STOP</span>
          </div>
        </ng-template>
        <div class="flex flex-col gap-3">
          <div class="flex justify-between items-start gap-4">
            <div class="flex-1 min-w-0">
              <p class="text-lg font-semibold m-0 text-surface-900">{{ nextStop()?.address }}</p>
              @if (nextStop()?.addressNotes) {
                <p class="text-sm m-0 mt-1 text-surface-500">{{ nextStop()?.addressNotes }}</p>
              }
              <p class="text-sm m-0 mt-2 text-surface-400">
                Stop #{{ nextStop()?.routeSequence }} of {{ totalCount() }}
              </p>
            </div>
            <p-tag severity="warn" value="Pending" />
          </div>
          <div class="flex gap-2">
            <p-button
              label="Navigate"
              icon="pi pi-map-marker"
              (onClick)="openGoogleMaps(nextStop()!)"
              styleClass="flex-1"
            />
            <p-button
              icon="pi pi-check"
              severity="success"
              (onClick)="markComplete(nextStop()!)"
              pTooltip="Mark Complete"
              ariaLabel="Mark as complete"
            />
          </div>
        </div>
      </p-card>
    }

    @if (isMobile()) {
      <!-- Mobile Card View -->
      <div class="flex flex-col gap-3">
        @for (collection of collections(); track collection.id) {
          <p-card [class.opacity-60]="collection.collected">
            <div class="flex flex-col gap-3">
              <div class="flex justify-between items-start gap-3">
                <div class="flex items-start gap-3 flex-1 min-w-0">
                  <span
                    class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
                    [class.bg-green-100]="collection.collected"
                    [class.text-green-700]="collection.collected"
                    [class.bg-surface-100]="!collection.collected"
                    [class.text-surface-700]="!collection.collected"
                  >
                    {{ collection.routeSequence }}
                  </span>
                  <div class="flex-1 min-w-0">
                    <p class="font-medium m-0 text-surface-900">{{ collection.address }}</p>
                    @if (collection.addressNotes) {
                      <p class="text-sm m-0 mt-1 text-surface-500">{{ collection.addressNotes }}</p>
                    }
                    @if (collection.notes) {
                      <p class="text-sm m-0 mt-1 text-surface-400 italic">
                        <i class="pi pi-comment mr-1" aria-hidden="true"></i>{{ collection.notes }}
                      </p>
                    }
                  </div>
                </div>
                @if (collection.collected) {
                  <p-tag severity="success" value="Done" />
                } @else {
                  <p-tag severity="warn" value="Pending" />
                }
              </div>
              <div class="flex gap-2">
                <p-button
                  icon="pi pi-map-marker"
                  label="Navigate"
                  severity="info"
                  [outlined]="true"
                  size="small"
                  (onClick)="openGoogleMaps(collection)"
                  styleClass="flex-1"
                />
                <p-button
                  icon="pi pi-pencil"
                  severity="secondary"
                  [outlined]="true"
                  size="small"
                  (onClick)="openNotesDialog(collection)"
                  ariaLabel="Add notes"
                />
                @if (!collection.collected) {
                  <p-button
                    icon="pi pi-check"
                    severity="success"
                    size="small"
                    (onClick)="markComplete(collection)"
                    ariaLabel="Mark complete"
                  />
                }
              </div>
            </div>
          </p-card>
        } @empty {
          <div class="text-center py-12">
            <i class="pi pi-inbox text-5xl text-surface-300 mb-4"></i>
            <p class="text-surface-500 m-0">No collections scheduled for today</p>
          </div>
        }
      </div>
    } @else {
      <!-- Desktop Table View -->
      <p-table
        [value]="collections()"
        [tableStyle]="{ 'width': '100%' }"
        [scrollable]="true"
        scrollHeight="55vh"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 60px">#</th>
            <th>Address</th>
            <th style="width: 200px">Notes</th>
            <th style="width: 100px">Status</th>
            <th style="width: 150px">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-collection>
          <tr [class.bg-green-50]="collection.collected">
            <td class="font-medium">{{ collection.routeSequence }}</td>
            <td>
              <div>
                <span class="font-medium">{{ collection.address }}</span>
                @if (collection.addressNotes) {
                  <p class="text-sm text-surface-500 mt-1 m-0">{{ collection.addressNotes }}</p>
                }
              </div>
            </td>
            <td>
              <span class="text-sm text-surface-500">{{ collection.notes || '-' }}</span>
            </td>
            <td>
              @if (collection.collected) {
                <p-tag severity="success" value="Complete" />
              } @else {
                <p-tag severity="warn" value="Pending" />
              }
            </td>
            <td>
              <div class="flex gap-1">
                <p-button
                  icon="pi pi-map-marker"
                  severity="info"
                  [text]="true"
                  [rounded]="true"
                  (onClick)="openGoogleMaps(collection)"
                  pTooltip="Open in Maps"
                  ariaLabel="Open in Maps"
                />
                <p-button
                  icon="pi pi-pencil"
                  severity="secondary"
                  [text]="true"
                  [rounded]="true"
                  (onClick)="openNotesDialog(collection)"
                  pTooltip="Add Notes"
                  ariaLabel="Add Notes"
                />
                @if (!collection.collected) {
                  <p-button
                    icon="pi pi-check"
                    severity="success"
                    [text]="true"
                    [rounded]="true"
                    (onClick)="markComplete(collection)"
                    pTooltip="Mark Complete"
                    ariaLabel="Mark Complete"
                  />
                }
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5" class="text-center py-12">
              <i class="pi pi-inbox text-5xl text-surface-300 mb-4"></i>
              <p class="text-surface-500 m-0">No collections scheduled for today</p>
            </td>
          </tr>
        </ng-template>
      </p-table>
    }
  }
</div>

<!-- Notes Dialog -->
<p-dialog
  header="Collection Notes"
  [(visible)]="showNotesDialog"
  [modal]="true"
  [style]="{ width: isMobile() ? '90vw' : '400px' }"
  [draggable]="false"
  [resizable]="false"
>
  <div class="flex flex-col gap-4">
    <div>
      <label for="notes" class="block font-medium mb-2">Notes</label>
      <textarea
        pTextarea
        id="notes"
        rows="4"
        [ngModel]="collectionNotes()"
        (ngModelChange)="collectionNotes.set($event)"
        placeholder="Enter notes about this collection..."
        class="w-full"
      ></textarea>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <p-button label="Cancel" severity="secondary" [outlined]="true" (onClick)="closeNotesDialog()" />
      <p-button label="Save" (onClick)="saveNotes()" />
    </div>
  </ng-template>
</p-dialog>
